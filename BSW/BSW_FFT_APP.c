#include "BSW_FFT_APP.h"
#include "stm32_dsp.h"
#include "table_fft.h"
#include "arm_math.h"
#include "arm_const_structs.h"
#include "arm_common_tables.h"
#include <string.h>
#include "stdio.h"
#include "Lib_Log_Util.h"
#include "MCAL_APM32.h"
#define Fs 100000
#define FFT_LENGTH 1024

float32 lBufInArray[FFT_LENGTH * 2] = {0};
float32 lBufOutArray[FFT_LENGTH / 2] = {0};
uint16 ADC_Value[FFT_LENGTH] = {0};
uint16 ADC_my_test_value[1024]= {0};

uint32 maxIndex = 0;
float32 maxIndex_1 = 0;
float32 maxValue = 0;
float32 frequency = 0;
arm_rfft_instance_f32 fftInstance;
float32 fftOutput[1024];
float32 fftInput[1024];
// {0,79,79,120,741,719,748,774,789,874,878,885,942,957,930,950,1013,1031,1001,1019,1036,1047,1055,1104,1103,1112,1122,1077,1084,1132,1121,1075,1116,1058,1054,1041,1027,1073,999,1025,959,945,972,943,879,854,834,810,789,769,736,758,734,667,654,679,719,669,655,652,638,616,639,608,587,572,500,481,513,483,404,384,359,338,354,292,331,313,292,232,223,251,244,195,200,198,201,213,255,246,223,210,166,176,231,239,216,235,303,280,308,382,394,371,452,435,462,539,564,546,579,646,667,691,671,744,758,785,764,790,865,917,881,943,913,972,992,962,988,1052,1059,1032,1046,1095,1088,1062,1116,1071,1086,1087,1072,1127,1117,1115,1061,1054,1085,1071,1008,1001,1021,963,987,966,948,880,903,835,807,834,803,735,713,736,706,650,639,714,717,703,649,638,656,636,568,548,534,513,531,464,444,460,431,359,336,355,335,280,318,296,266,217,211,244,245,230,200,197,251,256,195,190,180,169,177,233,240,210,278,255,276,345,371,348,373,407,437,507,485,565,591,616,590,613,687,713,686,762,742,807,828,813,868,926,934,905,928,987,1012,982,1000,1018,1030,1090,1096,1093,1101,1117,1077,1077,1127,1130,1071,1075,1115,1064,1054,1080,1076,1059,1037,978,964,995,975,906,883,864,841,860,789,811,784,755,690,678,695,679,671,718,664,655,638,623,640,613,594,533,502,532,509,432,457,384,366,339,319,340,280,322,250,235,267,258,198,204,201,202,207,209,213,248,224,171,174,215,223,198,199,238,259,279,349,362,394,416,398,427,503,530,507,544,573,598,622,687,713,689,758,739,761,829,849,861,924,929,948,966,985,1006,1028,1037,1015,1029,1074,1091,1048,1063,1068,1123,1124,1081,1082,1124,1121,1069,1069,1098,1084,1031,1016,1002,1032,967,944,975,949,930,859,838,863,836,765,743,719,698,722,701,681,664,723,662,654,686,665,593,575,597,534,512,497,518,484,460,386,366,379,361,296,280,275,311,278,217,209,246,231,196,202,250,247,206,205,187,221,216,160,228,235,250,223,255,317,337,321,346,419,396,425,504,527,506,584,571,589,663,685,663,686,758,783,802,777,851,898,920,888,909,968,983,959,982,1000,1060,1076,1036,1049,1099,1101,1070,1079,1124,1126,1083,1127,1079,1077,1109,1054,1092,1031,1063,1002,984,1016,996,928,958,935,868,845,821,846,817,788,721,698,727,700,643,710,676,667,700,643,667,599,621,553,539,554,538,475,447,421,399,369,345,319,341,327,269,258,282,265,208,207,245,195,247,242,246,255,242,180,167,215,217,172,236,206,226,295,317,291,365,385,368,395,468,497,483,505,537,609,631,607,683,705,727,706,730,801,818,799,853,922,887,904,967,982,964,1020,993,1013,1070,1082,1041,1053,1108,1113,1115,1079,1129,1122,1131,1070,1072,1108,1099,1045,1074,1017,1004,1031,1012,950,976,956,889,863,893,868,793,771,749,767,697,679,707,690,706,678,667,699,686,622,600,584,492,547,568,545,474,493,422,407,418,385,320,301,327,272,266,243,269,253,246,202,195,242,247,199,253,202,233,214,165,171,223,227,207,228,292,312,292,315,389,408,393,424,491,522,547,528,563,634,649,635,664,721,705,731,795,820,798,896,879,888,944,961,938,955,1028,992,1054,1022,1081,1084,1087,1059,1070,1121,1120,1081,1081,1082,1080,1115,1072,1062,1089,1080,1013,1007,1032,1016,955,976,908,895,919,846,872,799,822,748,726,749,722,661,649,671,729,672,662,646,675,643,579,559,577,562,496,474,499,428,400,418,388,365,343,279,277,307,281,227,212,211,206,240,204,248,246,250,202,185,222,212,165,219,229,196,266,284,304,324,349,334,365,435,459,441,472,551,527,561,630,648,624,700,677,698,766,793,773,797,888,878,932,900,959,982,994,964,995,1055,1065,1030,1045,1055,1101,1111,1115,1072,1124,1119,1078,1077,1117,1108,1058,1046,1083,1018,1009,998,1017,1000,979,912,890,920,894,823,800,822,752,731,748,728,659,687,662,682,717,704,641,671,651,586,560,549,569,534,516,451,432,444,420,345,322,299,295,322,262,242,275,258,197,199,250,239,191,201,208,256,226,169,218,214,215,185,196,268,284,256,282,356,330,402,429,454,437,512,496,534,595,622,603,671,649,722,746,719,792,807,831,835,869,922,938,910,933,953,976,1040,1003,1024,1088,1079,1045,1061,1111,1109,1075,1081,1087,1083,1081,1126,1110,1100,1090,1033,1026,1047,1034,974,954,938,925,902,880,904,873,845,779,757,777,749,681,669,651,664,685,675,712,653,678,605,592,608,587,517,499,484,504,434,451,377,394,364,300,290,313,309,239,268,209,204,245,239,240,232,243,207,199,229,215,168,172,178,188,208,223,245,310,325,299,332,399,425,411,440,481,499,572,600,619,643,667,648,673,1124,1086,1086,1122,1115,1061,1096,1038,1031,1015,999,1026,1005,980,919,903,921,899,831,854};

void InitBufInArray(void)
{
    unsigned short i;
    float32 fx;
    for (i = 0; i < FFT_LENGTH; i++) 
    {
        fx = 1024 * sin(2 * PI * i * 13500.0f /Fs) 
            + 512 * sin(2 * PI * i * 8500.0f  /Fs) 
            + 512 * sin(2 * PI * i * 3500.0f  /Fs);
        ADC_Value[i] = fx + 2048;
    }
}

void FFT(void)
{
    //InitBufInArray();
    Log_d("\nADC_my_test_value= %d\n",sizeof(ADC_my_test_value));
    for (int i = 0; i < FFT_LENGTH; i++) {
        //lBufInArray[i *2 ] = ADC_Value[i]; //实部赋值
        lBufInArray[i *2 ] = (ADC_my_test_value[i]*3.3)/4096; //实部赋值
        lBufInArray[i * 2 + 1] = 0; //虚部赋值
    }
    arm_cfft_f32(&arm_cfft_sR_f32_len1024, lBufInArray, 0, 1); //傅里叶变换
    arm_cmplx_mag_f32(lBufInArray, lBufOutArray, FFT_LENGTH); /// 取模
    Log_d("Result:\n");
    lBufOutArray[0] /= 1024;
    for (int i = 1; i < FFT_LENGTH/2; i++) {
        lBufOutArray[i] /= 512; //归一化
        Log_d("%.4f\n",i, lBufOutArray[i]);
    }
    Log_d("END!\n");

    // arm_rfft_fast_f32(&fftInstance,fftInput,fftOutput,0); //执行FFT
    arm_max_f32(lBufOutArray,512,&maxValue,&maxIndex); //查找最大幅度的频率
    Log_d("maxValue : %f,maxIndex:%d!\r\n",maxValue,maxIndex);
    if ((maxValue > 0) && (maxIndex == 0)) {
        for (int i = 0; i < 512; i++) {
            if(lBufOutArray[i] > 1) {
                maxIndex_1 = (float32)(i-1) + 0.5f;
            }
        }
    } else {
        maxIndex_1 = maxIndex;
    }
    frequency = (float32_t)maxIndex_1 * 1024 / 1024;
    Log_d("frequency : %f!\r\n",frequency);
    TMR_Enable(TMR3);   
}

void get_adcvalues(uint16* adcbuffer)
{
    for (int i = 0; i < 1024; i++) {
        ADC_my_test_value[i] = adcbuffer[i];
        fftInput[i] = adcbuffer[i];
    }
}

